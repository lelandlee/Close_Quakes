<!-- To DO:
Get directions for traveling down
Create filters
-->

<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <!--The viewport meta tag is used to improve the presentation and behavior of the samples 
      on iOS devices-->
    <meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no">
    <title>Select with feature layer</title>
    <link rel="stylesheet" href="http://js.arcgis.com/3.11/dijit/themes/tundra/tundra.css">
    <link rel="stylesheet" href="http://js.arcgis.com/3.11/esri/css/esri.css">
    <style>
      html, body, #mapDiv {
        padding: 0;
        margin: 0;
        height: 100%;
      }
      span{
        background-color: #fff;
        box-shadow: 0 0 5px #888;
        font-size: 1.1em;
        max-width: 15em;
        padding: 0.5em;
      }
      #messages{
        position: absolute;
        right: 20px;
        top: 20px;
        z-index: 40;
      }
      #info-window {
        position: absolute;
        left: 20px;
        top: 20px;
        z-index: 40;
      }
    </style>
    <script src="http://js.arcgis.com/3.11/"></script>
    <script>
      var map;
      require([
        "esri/map", "esri/layers/FeatureLayer", 
        "esri/tasks/query", "esri/geometry/Circle",
        "esri/graphic", "esri/InfoTemplate", "esri/symbols/SimpleMarkerSymbol",
        "esri/symbols/SimpleLineSymbol", "esri/symbols/SimpleFillSymbol", "esri/renderers/SimpleRenderer",
        //new
        "esri/layers/GraphicsLayer", "esri/Color", "esri/geometry/Point",
        "esri/tasks/FeatureSet", "esri/tasks/ClosestFacilityTask",
        "esri/tasks/ClosestFacilityParameters",
        //end of new
        "esri/config", "esri/Color", "dojo/dom", "dojo/domReady!"
      ], function(
        Map, FeatureLayer,
        Query, Circle,
        Graphic, InfoTemplate, SimpleMarkerSymbol,
        SimpleLineSymbol, SimpleFillSymbol, SimpleRenderer,
        //new
        GraphicsLayer, Color, Point, 
        FeatureSet, ClosestFacilityTask, ClosestFacilityParameters,
        //end
        esriConfig, Color, dom
      ) {
        // use a proxy page if a URL generated by this page is greater than 2000 characters
        //
        // this should not be needed as nearly all query & select functions are performed on the client
        esriConfig.defaults.io.proxyUrl = "/proxy/";
        
        //getting user location
        var defaultLat = -149.37;
        var defaultLong = 61.108;
        var currentLat = 0;
        var currentLong = 0;
        function getLocation() {
          console.log("done");
          if (navigator.geolocation) {
              navigator.geolocation.getCurrentPosition(showPosition, showError);
          } else {
              console.log("Geolocation is not supported by this browser.");
          }
        };
        function showPosition(position) {
          currentLat = position.coords.latitude;
          currentLong = position.coords.longitude; 
          console.log(currentLat + " " + currentLong);
        }
        function showError(error) {
          switch(error.code) {
            case error.PERMISSION_DENIED:
              console.log("User denied the request for Geolocation.");
              currentLat = defaultLat;
              currentLong = defaultLong;
              break;
            case error.POSITION_UNAVAILABLE:
              console.log("Location information is unavailable.");
              break;
            case error.TIMEOUT:
              console.log("The request to get user location timed out.");
              break;
            case error.UNKNOWN_ERROR:
              console.log("An unknown error occurred.");
              break;
          }
        }

        getLocation();
        console.log(currentLat + " " + currentLong);
        setTimeout( function() {
          console.log(currentLat + " " + currentLong);
        }, 1000);
        //what to do to wait to load for the data to come then load the map??

        var infoTemplate = new InfoTemplate(
            "Magnitude: ${MAGNITUDE:esriFieldTypeDouble }");

        map = new Map("mapDiv", { 
          basemap: "streets",
          center: [defaultLat, defaultLong],
          //center: [currentLat, currentLong],
          zoom: 7,
          slider: false,
          infoTemplate: infoTemplate
        });        
        
        //add the census block points in on demand mode. Note that an info template has been defined so when 
        //selected features are clicked a popup window will appear displaying the content defined in the info template.
        var featureLayer = new FeatureLayer("http://tmservices1.esri.com/arcgis/rest/services/LiveFeeds/Earthquakes/MapServer/0",{
          infoTemplate: new InfoTemplate("Block: ${BLOCK}", "${*}"),
          outFields: ["MAGNITUDE","DEPTH"],
          dataAttributes:["MAGNITUDE"]
        });

        // selection symbol used to draw the selected census block points within the buffer polygon
        var symbol = new SimpleMarkerSymbol(
          SimpleMarkerSymbol.STYLE_CIRCLE, 
          12, 
          new SimpleLineSymbol(
            SimpleLineSymbol.STYLE_NULL,
            new Color([247, 34, 101, 0.9]), 
            1
          ),
          new Color([0, 34, 171, 0.5])
        );
        featureLayer.setSelectionSymbol(symbol);

        //attempts to create a rendering based on intensity
        var render = new SimpleRenderer(symbol);
        render.setColorInfo({
          field: "MAGNITUDE",
          minDataValue: 0,
          maxDataValue: 10,
          colors: [
            new Color([255, 255, 0]),
            new Color([255, 0, 0])
          ]
        });
        
        featureLayer.setRenderer(render); 
        
        //make unselected features invisible
        var nullSymbol = new SimpleMarkerSymbol().setSize(0);
        //below hides all of feature....
        //featureLayer.setRenderer(new SimpleRenderer(nullSymbol));
        
        map.addLayer(featureLayer);
        
        var circleSymb = new SimpleFillSymbol(
          SimpleFillSymbol.STYLE_NULL,
          new SimpleLineSymbol(
            SimpleLineSymbol.STYLE_SHORTDASHDOTDOT,
            new Color([105, 105, 105]),
            2
          ), new Color([255, 255, 0, 0.25])
        );
        var circle;

        //when the map is clicked create a buffer around the click point of the specified distance.
        var incidentsGraphicsLayer, params;
        map.on("click", function(evt){
          circle = new Circle({
            center: evt.mapPoint, //find out more about this
            geodesic: true,
            radius: 50,
            radiusUnit: "esriMiles"
          });
          //convert to coordinates if necessary
          console.log("center: " + circle.center.x + " " + circle.center.y);
          map.graphics.clear();
          map.infoWindow.hide();
          var graphic = new Graphic(circle, circleSymb);
          map.graphics.add(graphic);

          var query = new Query();
          query.geometry = circle.getExtent();
          //use a fast bounding box query. will only go to the server if bounding box is outside of the visible map
          featureLayer.queryFeatures(query, selectInBuffer);
          
          //new
          //adding distance related stuff, check to see if this stuff works?
          //parameters for finding directions
          params = new ClosestFacilityParameters();
          params.impedenceAttribute= "Miles";      
          params.defaultCutoff= 50.0;      
          params.returnIncidents=false;
          params.returnRoutes=true;
          params.returnDirections=true;

          //why isnt this layer showing?
          var incidentPointSymbol = new SimpleMarkerSymbol(
            SimpleMarkerSymbol.STYLE_CIRCLE, 
            15,
            new SimpleLineSymbol(
              SimpleLineSymbol.STYLE_SOLID,
              new Color([89,95,35]), 2
            ),
            new Color([225,50,225,0.70])
          ); 
          
          
          incidentsGraphicsLayer = new GraphicsLayer();
          var incidentsRenderer = new SimpleRenderer(incidentPointSymbol);
          incidentsGraphicsLayer.setRenderer(incidentsRenderer);
          map.addLayer(incidentsGraphicsLayer);

          //adds point in center of circle
          var inPoint = new Point(evt.mapPoint.x, evt.mapPoint.y, map.spatialReference);
          var location = new Graphic(inPoint);
          incidentsGraphicsLayer.clear();//why doesn't this want to clear
          incidentsGraphicsLayer.add(location);

          params.featureLayer = featureLayer;//should it be converted to graphics layer?
          params.outSpatialReference = map.spatialReference;
          //create a new featureLayer from selected objects?

          
        });
      

        function selectInBuffer(response){
          var feature;
          var features = response.features;
          var inBuffer = [];
          //filter out features that are not actually in buffer, since we got all points in the buffer's bounding box
          for (var i = 0; i < features.length; i++) {
            feature = features[i];
            if(circle.contains(feature.geometry)){
              inBuffer.push(feature.attributes[featureLayer.objectIdField]);
            }
          }
          var query = new Query();
          query.objectIds = inBuffer;
          //use a fast objectIds selection query (should not need to go to the server)
          featureLayer.selectFeatures(query, FeatureLayer.SELECTION_NEW, function(results){
            var totalOccurances = sumOccurances(results);
            var largestMagnitude = findLargestMagnitude(results);
            var r = "";
            r = "<b>The total occurances is <i>" + totalOccurances + "</i>.</b>";
            r +="<br>Richter Scale >8.0 : " + numInRange(results, 8, 100);
            r +="<br>Richter Scale 6.0 - 7.9 : " + numInRange(results, 6, 8);
            r +="<br>Richter Scale 4.0 - 5.9 : " + numInRange(results, 4, 6);
            r +="<br>Richter Scale <3.9 : " + numInRange(results, 0, 4);
            r += "<br>Largest Quake: " + largestMagnitude;
            dom.byId("messages").innerHTML = r;
            for (var x = 0; x < features.length; x++) {
              console.log("here");
              var magnitude = features[x].attributes["MAGNITUDE"];
              if(magnitude >= 4)
                features[x].attr("fill", "#000");
                features[x].attr("opacity", "1.0");
            };
          });
        }

        function numInRange(features, low, high){
          var number = 0;
          for (var x = 0; x < features.length; x++) {
            var magnitude = features[x].attributes["MAGNITUDE"];
            if(magnitude >= low && magnitude < high)
              number++;
          };
          return number;
        }
        function sumOccurances(features) {
          var sum = 0;
          for (var x = 0; x < features.length; x++) {
            sum = sum + features[x].attributes["MAGNITUDE"];
          }
          return features.length;
        }
        function findLargestMagnitude(features) {
          var largest = 0
          var position = 0;
          for (var x = 0; x < features.length; x++) {
            if(features[x].attributes["MAGNITUDE"] > largest)
              largest = features[x].attributes["MAGNITUDE"];
              position = x;
          }
          return largest;
        }

        featureLayer.on("mouse-over", function(evt) {
          console.log("mouse-over");
          var text = "<b>Incident Information:</b>";
          text += "<br>Magnitude: " + evt.graphic.attributes["MAGNITUDE"];
          dom.byId("info-window").innerHTML = text;
        })
        featureLayer.on("mouse-out", function(evt) {
          console.log("mouse-out");
          dom.byId("info-window").innerHTML = "Incident Information:";
        })
      });
    </script>
  </head>

  <body>
    <span id="messages">Click on the map to select census block points within 100 mile.</span>
    <span id="info-window">Incident Information:</span>
    <div id="mapDiv"></div>
  </body>
</html>
 